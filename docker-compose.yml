# ============================================================================
# DOCKER COMPOSE - LOCAL DEVELOPMENT & TESTING
# ============================================================================

version: '3.8'

services:
  # Main application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - API_KEY_SECRET=${API_KEY_SECRET}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - CREEM_API_KEY=${CREEM_API_KEY}
      - CREEM_WEBHOOK_SECRET=${CREEM_WEBHOOK_SECRET}
      - CREEM_PRODUCT_STARTER=${CREEM_PRODUCT_STARTER}
      - CREEM_PRODUCT_PRO=${CREEM_PRODUCT_PRO}
      - CREEM_PRODUCT_ENTERPRISE=${CREEM_PRODUCT_ENTERPRISE}
    env_file:
      - .env.local
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3000/api/health/live', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 30s
    networks:
      - bluesmind-network

networks:
  bluesmind-network:
    driver: bridge
